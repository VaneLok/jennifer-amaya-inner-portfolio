<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DOOM - Maximum Speed</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            color: #fff;
            font-family: monospace;
            overflow: hidden;
        }
        
        .doom-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            background: #000;
        }
        
        #gameArea {
            width: 100%;
            height: 100%;
            border: none;
            background: #000;
        }
        
        .speed-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            transition: opacity 0.2s ease;
        }
        
        .speed-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .doom-logo {
            font-size: 3rem;
            color: #8B0000;
            font-weight: bold;
            letter-spacing: 3px;
            animation: quickPulse 0.8s infinite;
        }
        
        @keyframes quickPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.05); }
        }
        
        /* Aggressive hiding of any loading elements */
        .dosbox-container .dosbox-loading,
        .dosbox-container .dosbox-start,
        .jsdos-loading,
        .emulators-ui-loading,
        .dosbox-start-button,
        .dos-loading,
        .loading-screen,
        .start-screen {
            display: none !important;
            opacity: 0 !important;
            visibility: hidden !important;
        }
    </style>
</head>
<body>
    <div class="doom-container">
        <div id="gameArea"></div>
        
        <div class="speed-overlay" id="overlay">
            <div class="doom-logo">DOOM</div>
        </div>
    </div>

    <script>
        class MaxSpeedDoom {
            constructor() {
                this.overlay = document.getElementById('overlay');
                this.gameArea = document.getElementById('gameArea');
                this.startTime = Date.now();
                this.attempts = 0;
                this.maxAttempts = 4;
                
                // List of sources ordered by expected speed - using working sources
                this.sources = [
                    { type: 'local', url: null, name: 'Local js-dos' },
                    { type: 'external', url: 'https://silentspacemarine.com/', name: 'Silent Space Marine' },
                    { type: 'external', url: 'https://archive.org/embed/DoomsharewareEpisode', name: 'Internet Archive' },
                    { type: 'external', url: 'https://dos.zone/doom/', name: 'DOS Zone' }
                ];
                
                this.init();
            }
            
            async init() {
                console.log('Initializing maximum speed DOOM...');
                this.tryNextSource();
            }
            
            async tryNextSource() {
                if (this.attempts >= this.maxAttempts) {
                    console.error('All DOOM sources failed');
                    this.showError();
                    return;
                }
                
                const source = this.sources[this.attempts];
                this.attempts++;
                
                console.log(`Trying source ${this.attempts}/${this.maxAttempts}: ${source.name}`);
                
                if (source.type === 'local') {
                    this.tryLocalDoom();
                } else {
                    this.tryExternalDoom(source.url);
                }
            }
            
            async tryLocalDoom() {
                try {
                    // Try to load js-dos locally
                    const script = document.createElement('script');
                    script.src = 'js-dos/js-dos.js';
                    
                    script.onload = async () => {
                        try {
                            const Dos = window.Dos;
                            if (!Dos) throw new Error('js-dos not loaded');
                            
                            const dosInstance = Dos(this.gameArea, {
                                wdosboxUrl: "js-dos/wdosbox.js",
                                cycles: "max",
                                autoStart: true
                            });
                            
                            await dosInstance.run("doom.jsdos");
                            this.onGameReady('Local js-dos');
                            
                        } catch (error) {
                            console.log('Local js-dos failed:', error);
                            this.tryNextSource();
                        }
                    };
                    
                    script.onerror = () => {
                        console.log('js-dos script failed to load');
                        this.tryNextSource();
                    };
                    
                    document.head.appendChild(script);
                    
                    // Timeout for local attempt
                    setTimeout(() => {
                        if (this.overlay && !this.overlay.classList.contains('hidden')) {
                            console.log('Local js-dos timeout');
                            this.tryNextSource();
                        }
                    }, 3000);
                    
                } catch (error) {
                    console.log('Local DOOM setup failed:', error);
                    this.tryNextSource();
                }
            }
            
            tryExternalDoom(url) {
                const iframe = document.createElement('iframe');
                iframe.src = url;
                iframe.style.cssText = 'width: 100%; height: 100%; border: none; background: #000;';
                iframe.setAttribute('allow', 'autoplay; fullscreen; gamepad; clipboard-write; cross-origin-isolated');
                iframe.setAttribute('allowfullscreen', 'true');
                
                iframe.onload = () => {
                    this.onGameReady(`External: ${url}`);
                };
                
                iframe.onerror = () => {
                    console.log(`External source failed: ${url}`);
                    this.tryNextSource();
                };
                
                this.gameArea.innerHTML = '';
                this.gameArea.appendChild(iframe);
                
                // Timeout for external sources
                setTimeout(() => {
                    if (this.overlay && !this.overlay.classList.contains('hidden')) {
                        console.log(`External source timeout: ${url}`);
                        this.tryNextSource();
                    }
                }, 4000);
            }
            
            onGameReady(source) {
                const totalTime = Date.now() - this.startTime;
                console.log(`DOOM ready from ${source} in ${totalTime}ms`);
                
                // Hide overlay immediately
                this.overlay.classList.add('hidden');
                
                // Focus and interact with the game
                setTimeout(() => {
                    const canvas = document.querySelector('canvas');
                    const iframe = document.querySelector('iframe');
                    
                    if (canvas) {
                        canvas.focus();
                        canvas.click();
                    } else if (iframe) {
                        iframe.focus();
                    }
                }, 100);
            }
            
            showError() {
                this.gameArea.innerHTML = `
                    <div style="
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        height: 100%;
                        flex-direction: column;
                        color: #ff4444;
                        font-size: 18px;
                        text-align: center;
                    ">
                        <div style="margin-bottom: 20px;">Unable to load DOOM</div>
                        <button onclick="location.reload()" style="
                            background: #8B0000;
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            font-family: monospace;
                            cursor: pointer;
                            font-size: 14px;
                        ">Try Again</button>
                    </div>
                `;
                this.overlay.classList.add('hidden');
            }
        }
        
        // Start immediately
        new MaxSpeedDoom();
        
        // Aggressively hide any loading elements that might appear
        const hideLoadingElements = () => {
            const selectors = [
                '.dosbox-loading',
                '.dosbox-start', 
                '.jsdos-loading',
                '.emulators-ui-loading',
                '.dosbox-start-button',
                '.dos-loading',
                '.loading-screen',
                '.start-screen'
            ];
            
            selectors.forEach(selector => {
                document.querySelectorAll(selector).forEach(el => {
                    el.style.display = 'none';
                    el.style.opacity = '0';
                    el.style.visibility = 'hidden';
                });
            });
        };
        
        // Run periodically to catch any loading screens
        setInterval(hideLoadingElements, 100);
        
        // Also use mutation observer
        const observer = new MutationObserver(hideLoadingElements);
        observer.observe(document.body, { childList: true, subtree: true });
    </script>
</body>
</html>
